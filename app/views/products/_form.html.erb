<div class="form-container">
  <div class="form-card">
    <%= form_with model: @product, local: true, html: { multipart: true } do |f| %>
    <%# <%= form_with model: @product, local: true, html: { multipart: true } do |form| %> 

      <% if @product.errors.any? %>
        <div class="alert">
          <ul>
            <% @product.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>



      <!-- ✅ プレビュー画像（1個のimgタグだけ使う） -->
      <div class="form-card">
        <p>商品画像プレビュー:</p>
        <img id="camera-preview-image"
             src="<%=
               if session[:product_image_blob_id].present?
                 blob = ActiveStorage::Blob.find_by(id: session[:product_image_blob_id])
                 blob ? url_for(blob) : ''
               elsif @product.image.attached?
                  url_for(@product.image)
               else
                ''
                end
             %>"
             style="max-width: 100%; height: auto;"
          />
      </div>

      <!-- ✅ 通常の画像アップロード -->
      <div class="img-upload">
        <strong>商品画像:</strong>
        <span class="optional">任意</span>
        <div class="click-upload">
          <%= f.file_field :image, id: "product_image" %>
        </div>
      </div>

      <!-- ✅ カメラで撮影ボタン -->
      <div class="form-card">
        <p class="form-field">カメラで商品を撮影</p>
        <% if action_name == "edit" %>
          <%= link_to "カメラで撮影", camera_products_path(mode: "edit", product_id: @product.id, from_camera: 1), class: "form-button blue" %>
        <% else %>
          <%= link_to "カメラで撮影", camera_products_path(mode: "new"), class: "form-button blue" %>
        <% end %>
      </div>

      <!-- ✅ 商品名 -->
      <div class="form-field">
        <div><strong>商品名:</strong> <span class="indispensable">必須</span></div>
        <%= f.text_field :name, class: "products-text", id: "products-name", placeholder: "カタカナのみ", maxlength: "30" %>
      </div>

      <!-- ✅ 価格 -->
      <div class="form-field">
        <div><strong>価格:</strong> <span class="indispensable">必須</span></div>
        <%= f.text_field :price, class: "price-input", id: "products-price", placeholder: "半角数字のみ" %>
      </div>

      <!-- ✅ ボタン -->
      <div class="form-actions">
        <%= f.submit (local_assigns[:submit_text] || "保存"), class: "form-button yellow" %>
        <%= link_to "もどる", (local_assigns[:cancel_path] || products_path), class: "form-button gray" %>
      </div>
    <% end %>
  </div>
</div>

<!-- プレビュー表示（JSでsrcを設定） -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const imageData = sessionStorage.getItem("capturedImage");
    if (imageData) {
      const previewImg = document.getElementById("camera-preview-image");
      const serverImg = document.getElementById("server-image");
      if (previewImg) {
        previewImg.src = imageData;
        previewImg.style.display = "block";
      }
      if (serverImg) {
        serverImg.style.display = "none";
      }
      sessionStorage.removeItem("capturedImage");
    }
  });
</script>
