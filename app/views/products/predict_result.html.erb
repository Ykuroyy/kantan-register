<div class="container">
  <%= link_to "トップページに戻る", root_path, class: "btn btn-gray" %>

  <h2 class="form-heading">🔍 認識結果</h2>

  <!-- 画像プレビュー -->
  <div class="grid">
    <div class="card">
      <p class="preview-label">撮影した画像</p>
      <%= image_tag "", id: "recognized-preview-image",
                    class: "preview-image", style: "display:none; max-width:100%;",
                    alt: "撮影画像プレビュー" %>
    </div>
    <div class="card">
      <p class="preview-label">登録されている商品画像</p>
      <% if @best_product&.image&.attached? %>
        <%= image_tag @best_product.image.variant(resize_to_limit: [320,320]),
                      class: "preview-image" %>
      <% else %>
        <div class="preview-image no-image">画像なし</div>
      <% end %>
    </div>
  </div>

  <!-- ① ここから：ヒット判定 ＆ 類似上位 ＆ 全件スコア表 -->
  <% if @hit_scores.any? %>
    <p>✅ 商品ヒット：<strong><%= @best_product&.name || @best["name"] %></strong>（<%= (@best["score"]*100).round(1) %>%）</p>
  <% else %>
    <p style="color:red">一致する商品はありません（スコア < 20%）</p>
  <% end %>

  <% if @candidates.any? %>
    <h3>🔎 類似上位</h3>
    <ul>
      <% @candidates.each do |c| %>
        <li>
          <%= c[:name] %> — <%= (c[:score]*100).round(1) %>%
        </li>
      <% end %>
    </ul>
  <% end %>

  <h3>📊 全商品のスコア</h3>
  <table>
    <tr><th>商品名</th><th>スコア</th></tr>
    <% @all_scores.each do |c| %>
      <tr>
        <td><%= c[:name] %></td>
        <td><%= (c[:score]*100).round(1) %>%</td>
      </tr>
    <% end %>
  </table>
  <!-- ① ここまで -->

  <% if @best_product.present? %>
    …（ベストマッチ＆カートボタン）…
  <% else %>
    …（ヒットゼロ時メッセージ）…
  <% end %>

  <% if @candidate_products.any? %>
    …（既存の類似候補ループ）…
  <% elsif @best_product.blank? %>
    …（候補なしメッセージ）…
  <% end %>

  <% if @all_scores.present? %>
    <h3>📊 全商品の類似度スコア</h3>
    <table>
      <thead>
        <tr><th>画像</th><th>商品名</th><th>スコア</th><th>カート</th></tr>
      </thead>
      <tbody>
        <% @all_scores.each do |c| %>
          <tr>
            <!-- 画像セル -->
            <td>
              <% prod = Product.find_by(name: c[:name]) %>
              <% if prod&.image&.attached? %>
                <%= image_tag(prod.image.variant(resize_to_limit: [100,100])) %>
              <% else %>
                —
              <% end %>
            </td>
            <!-- 名前セル -->
            <td><%= c[:name] %></td>
            <!-- スコアセル -->
            <td><%= "#{(c[:score] * 100).round(1)}%" %></td>
            <!-- カートセル -->
            <td>
              <% if prod %>
                <%= form_with url: add_to_cart_products_path, local: true do %>
                  <%= hidden_field_tag :recognized_name, prod.name %>
                  <%= submit_tag "＋カート", class: "btn btn-sm btn-yellow" %>
                <% end %>
              <% else %>
                —
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% end %>

  <!-- 操作ボタン -->
  <%= link_to "撮影をやり直す", camera_products_path(mode: "order"),
              class: "btn btn-blue", style: "margin-top:1.2rem;" %>
  <%= link_to "レジに戻る", new_order_products_path,
              class: "btn btn-gray", style: "margin-top:.6rem;" %>
</div>