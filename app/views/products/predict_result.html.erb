<div class="container">
  <%= link_to "ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹", root_path, class: "btn btn-gray" %>

  <h2 class="form-heading">ğŸ” ç”»åƒèªè­˜çµæœ (å…¨å•†å“)</h2>

  <% if flash[:alert] %>
    <p style="color: red;"><%= flash[:alert] %></p>
  <% end %>

  <!-- ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
  <div class="grid">
    <div class="card">
      <p class="preview-label">æ’®å½±ã—ãŸç”»åƒ</p>
      <%# TODO: JavaScriptã§æ’®å½±ã—ãŸç”»åƒã‚’ã“ã“ã«è¡¨ç¤ºã™ã‚‹å‡¦ç†ã‚’è¿½åŠ ã™ã‚‹ %>
      <%= image_tag "", id: "recognized-preview-image",
                    class: "preview-image", style: "display:none; max-width:100%;",
                    alt: "æ’®å½±ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" %>

  </div>

  <% if @recognition_results.present? %>
    <h3>ğŸ“Š å…¨å•†å“ã®é¡ä¼¼åº¦ã‚¹ã‚³ã‚¢</h3>
    <table>
      <thead>
        <tr>
          <th>å•†å“ç”»åƒ</th>
          <th>å•†å“å</th>
          <th>ã‚¹ã‚³ã‚¢</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody>
        <% @recognition_results.each do |result| %>
          <% product = result[:product] %>
          <tr>
            <td>
              <% if product.image.attached? %>
                <%= image_tag product.image.variant(resize_to_limit: [100,100]), width: "100" %>
              <% else %>
                <span>ç”»åƒãªã—</span>
              <% end %>
            </td>
            <td><%= product.name %></td>
            <td><%= "%.3f" % result[:score] %></td> <%# ã‚¹ã‚³ã‚¢ã¯ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆã§ã¯ãªãã€0.000 ã‹ã‚‰ 1.000 ã®å½¢å¼ã§è¡¨ç¤º %>
            <td>
              <%= button_to "ã‚«ãƒ¼ãƒˆã«è¿½åŠ ", add_to_cart_products_path(recognized_name: product.name), method: :post, class: "btn btn-primary btn-sm" %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% else %>
    <p>èªè­˜çµæœã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>
  <% end %>


<!-- ã‚­ãƒ£ãƒƒã‚·ãƒ¥å†æ§‹ç¯‰ãƒœã‚¿ãƒ³ï¼ˆFlask API å©ãï¼‰ -->
<%# <%= link_to "ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ§‹ç¯‰ã™ã‚‹", build_cache_products_path %> 

  <hr style="margin-top: 1.5rem; margin-bottom: 1.5rem;">

  <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
  <%= link_to "æ’®å½±ã‚’ã‚„ã‚Šç›´ã™", camera_products_path(mode: "order"),
              class: "btn btn-blue", style: "margin-top:1.2rem;" %>
  <%= link_to "ãƒ¬ã‚¸ã«æˆ»ã‚‹", new_order_products_path,
              class: "btn btn-gray", style: "margin-top:.6rem;" %>

  <!-- ãƒ‡ãƒãƒƒã‚°ç”¨: sessionStorageã®å†…å®¹ã‚’è¡¨ç¤º -->
  <div style="border: 2px solid red; padding: 10px; margin-top: 20px; background-color: #fdd; color: #333;">
    <p style="font-weight: bold; margin-bottom: 5px;">ãƒ‡ãƒãƒƒã‚°æƒ…å ± (sessionStorage):</p>
    <p style="font-size: 0.9em; margin-bottom: 3px;">'capturedImage' ã®ã‚­ãƒ¼ã§ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ (æœ€åˆã®100æ–‡å­—):</p>
    <pre id="debug-session-storage" style="word-wrap: break-word; white-space: pre-wrap; background-color: #fff; padding: 5px; border: 1px solid #ccc; font-size: 0.8em;"></pre>
  </div>

  <script>
    function displaySessionStorageDebugInfo() {
      const debugElement = document.getElementById('debug-session-storage');
      if (debugElement) {
        const storedData = sessionStorage.getItem('capturedImage');
        if (storedData) {
          debugElement.textContent = storedData.substring(0, 100) + (storedData.length > 100 ? "..." : "");
        } else {
          debugElement.textContent = "sessionStorageã« 'capturedImage' ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
        }
      }
    }

    document.addEventListener('DOMContentLoaded', displaySessionStorageDebugInfo);
    // Turbo Drive ã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆã¯ turbo:load ã‚‚è€ƒæ…®
    document.addEventListener('turbo:load', displaySessionStorageDebugInfo);
  </script>
  <!-- ãƒ‡ãƒãƒƒã‚°ç”¨ã“ã“ã¾ã§ -->
</div>
