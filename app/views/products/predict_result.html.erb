<div class="container">
  <%= link_to "トップページに戻る", root_path, class: "btn btn-gray" %>

  <h2 class="form-heading">🔍 認識結果</h2>

  <!-- 画像プレビュー -->
  <div class="grid">
    <div class="card">
      <p class="preview-label">撮影した画像</p>
      <%= image_tag "", id: "recognized-preview-image",
                    class: "preview-image", style: "display:none; max-width:100%;",
                    alt: "撮影画像プレビュー" %>
    </div>
    <div class="card">
      <p class="preview-label">登録されている商品画像</p>
      <% if @best_product&.image&.attached? %>
        <%= image_tag @best_product.image.variant(resize_to_limit: [320,320]),
                      class: "preview-image" %>
      <% else %>
        <div class="preview-image no-image">画像なし</div>
      <% end %>
    </div>
  </div>

  <% if @best_product.present? %>
    <!-- —— ベストマッチ表示 —— -->
    <p style="margin-top:1rem;">
      ベストマッチ：
      <strong><%= @best_product.name %></strong>
      (<%= (@best["score"] * 100).round(1) %>%)
    </p>

    <!-- カート追加ボタン -->
    <%= form_with url: add_to_cart_products_path, method: :post, local: true do %>
      <%= hidden_field_tag :recognized_name, @best_product.name %>
      <%= submit_tag "カートに追加", class: "btn btn-yellow",
                      style: "margin-top:.8rem;" %>
    <% end %>

  <% else %>
    <!-- —— ヒットゼロ時 —— -->
    <p style="text-align:center; color:#c00; margin-top:1rem;">
      一致する商品はありませんでした。
    </p>
  <% end %>

  <% if @candidate_products.any? %>
    <h3 style="margin-top:1.5rem;">🔎 類似候補</h3>
    <ul style="display:flex; gap:1rem; flex-wrap:wrap;">
      <% @candidate_products.each do |prod| %>
        <% score = (@candidates.find { |c| c["name"] == prod.name }["score"] * 100).round(1) rescue 0 %>
        <li style="width:120px; text-align:center;">
          <%# 商品画像 %>
          <% if prod.image.attached? %>
            <%= image_tag prod.image.variant(resize_to_limit: [100,100]), alt: prod.name %>
          <% else %>
            <div style="width:100px; height:100px; background:#eee;
                        display:flex; align-items:center; justify-content:center;">
              no image
            </div>
          <% end %>

          <%# 商品名とスコア %>
          <p style="margin:0.5em 0 0;">
            <strong><%= prod.name %></strong><br>
            (<%= score %>%)
          </p>

          <%# カート追加ボタン %>
          <%= form_with url: add_to_cart_products_path, method: :post, local: true do %>
            <%= hidden_field_tag :recognized_name, prod.name %>
            <%= submit_tag "カートに追加", class: "btn btn-sm btn-yellow", style: "margin-top:0.5em;" %>
          <% end %>
        </li>
      <% end %>
    </ul>
  <% elsif @best_product.blank? %>
    <p style="text-align:center; color:#c00; margin-top:1rem;">
      類似候補もありませんでした。
    </p>
  <% end %>

  <% if @all_scores.present? %>
    <h3>📊 全商品の類似度スコア</h3>
    <table>
      <thead>…</thead>
      <tbody>
        <% @all_scores.each do |h| %>
          <% prod = Product.find_by(name: h["name"]) %>
          <tr>
            <td style="display:flex; align-items:center; gap:0.5em;">
              <% if prod&.image&.attached? %>
                <%= image_tag prod.image.variant(resize_to_limit:[50,50]), alt: prod.name %>
              <% else %>
                <div style="width:50px;height:50px;background:#eee;"></div>
              <% end %>
              <%= h["name"] %>
            </td>
            <td style="text-align:right;"><%= (h["score"]*100).round(1) %>%</td>
            <td>
              <% if prod %>
                <%= form_with url: add_to_cart_products_path, method: :post, local: true do %>
                  <%= hidden_field_tag :recognized_name, prod.name %>
                  <%= submit_tag "カートに追加", class: "btn btn-sm btn-yellow" %>
                <% end %>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% end %>



  <!-- 操作ボタン -->
  <%= link_to "撮影をやり直す",
      camera_products_path(mode: "order"),
      class: "btn btn-blue", style: "margin-top:1.2rem;" %>
  <%= link_to "レジに戻る",
      new_order_products_path,
      class: "btn btn-gray", style: "margin-top:.6rem;" %>
</div>