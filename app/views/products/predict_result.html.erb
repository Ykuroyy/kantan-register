<div class="container">
  <%= link_to "トップページに戻る", root_path, class: "btn btn-gray" %>

  <h2 class="form-heading">🔍 認識結果</h2>

  <!-- 画像プレビュー -->
  <div class="grid">
    <div class="card">
      <p class="preview-label">撮影した画像</p>
      <%= image_tag "", id: "recognized-preview-image",
                    class: "preview-image", style: "display:none; max-width:100%;",
                    alt: "撮影画像プレビュー" %>
    </div>
      <div class="card">
        <p class="preview-label">登録されている商品画像</p>

        <% if @hit_scores.any? %>
          <% if @best_product&.image&.attached? %>
            <%= image_tag @best_product.image.variant(resize_to_limit:[320,320]), class:"preview-image" %>
          <% else %>
            <div class="preview-image no-image">画像なし</div>
          <% end %>
        <% else %>
          <div class="preview-image no-image">一致する商品がありません</div>
        <% end %>
      </div>
  </div>

  <% if @candidates.any? %>
    <h3>🔎 類似上位</h3>
    <ul>
      <% @candidates.each do |c| %>
        <li>
          <%= c[:name] %> — <%= (c[:score]*100).round(1) %>%
        </li>
      <% end %>
    </ul>
  <% end %>

  <% if @all_similarity_scores.present? %>
    <h3>📊 全商品の類似度スコア</h3>
    <table>
      <thead>
        <tr><th>画像</th><th>商品名</th><th>スコア</th><th>カート</th></tr>
      </thead>
      <tbody>
        <% @all_similarity_scores.each do |c| %>
          <tr>
            <!-- 画像セル -->
            <td>
              <% prod = Product.find_by(name: c[:name]) %>
              <% if prod&.image&.attached? %>
                <%= image_tag(prod.image.variant(resize_to_limit: [100,100])) %>
              <% else %>
                —
              <% end %>
            </td>
            <!-- 名前セル -->
            <td><%= c[:name] %></td>
            <!-- スコアセル -->
            <td><%= "#{(c[:score] * 100).round(1)}%" %></td>
            <!-- カートセル -->
            <td>
              <% if prod %>
                <%= form_with url: add_to_cart_products_path, local: true do %>
                  <%= hidden_field_tag :recognized_name, prod.name %>
                  <%= submit_tag "＋カート", class: "btn btn-sm btn-yellow" %>
                <% end %>
              <% else %>
                —
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% end %>

  <!-- 操作ボタン -->
  <%= link_to "撮影をやり直す", camera_products_path(mode: "order"),
              class: "btn btn-blue", style: "margin-top:1.2rem;" %>
  <%= link_to "レジに戻る", new_order_products_path,
              class: "btn btn-gray", style: "margin-top:.6rem;" %>
</div>