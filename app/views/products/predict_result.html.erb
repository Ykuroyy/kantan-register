<%= link_to "トップページに戻る", root_path, class: "form-button gray" %>
<h2 class="form-heading">🔍 認識結果</h2>

<div class="form-container">
  <div class="form-card">
    <div class="image-group predict-images">
      <!-- 撮影した画像 -->
      <div class="image-block">
        <p class="preview-label">撮影した画像</p>
        <img id="recognized-preview-image"
             class="preview-image"
             style="display:none; max-width:100%;"
             alt="撮影画像プレビュー" />
      </div>
      <!-- 登録済み商品画像 -->
      <div class="image-block">
        <p class="preview-label">登録されている商品画像</p>
        <% if @product&.image&.attached? %>
          <%= image_tag(@product.image.variant(resize_to_limit: [320, 320]), class: "preview-image") %>
        <% else %>
          <div class="preview-image no-image">画像なし</div>
        <% end %>
      </div>
    </div>

    <% if @product.present? %>
      <!-- 商品ヒット時 -->
      <p>商品名：<strong><%= @product.name %></strong></p>
      <p>価格：¥<%= number_with_delimiter(@product.price) %></p>
      <% if @score.present? %>
        <p>類似度スコア：<%= (@score * 100).round(1) %>%</p>
        <p style="font-size:0.9em; color:gray;">※0〜100%で類似度を表示</p>
      <% end %>
      <%= form_with url: add_to_cart_products_path, method: :post, local: true do %>
        <%= hidden_field_tag :recognized_name, @product.name %>
        <%= submit_tag "カートに追加", class: "form-button yellow" %>
      <% end %>
    <% else %>
      <!-- ヒットなし: 再撮影のみ -->
      <p style="text-align:center; color:#666;">一致する商品がありませんでした</p>
    <% end %>

    <!-- 撮影をやり直す -->
    <%= link_to "撮影をやり直す", camera_products_path(mode: "order"), class: "form-button blue", style: "margin-top:16px;" %>

    <!-- レジに戻るボタン -->
    <%= link_to "レジに戻る", new_order_products_path, class: "form-button gray", style: "margin-top:8px;" %>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const imgData = sessionStorage.getItem("capturedImage");
    const imgEl = document.getElementById("recognized-preview-image");
    if (imgData && imgEl) {
      imgEl.src = imgData;
      imgEl.style.display = "block";
      sessionStorage.removeItem("capturedImage");
    }
  });
</script>