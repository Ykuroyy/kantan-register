<div class="container">
  <%= link_to "トップページに戻る", root_path, class: "btn btn-gray" %>

  <h2 class="form-heading">🔍 画像認識結果 (全商品)</h2>

  <% if flash[:alert] %>
    <p style="color: red;"><%= flash[:alert] %></p>
  <% end %>

  <!-- 画像プレビュー -->
  <div class="grid">
    <div class="card">
      <p class="preview-label">撮影した画像</p>
      <%# TODO: JavaScriptで撮影した画像をここに表示する処理を追加する %>
      <%= image_tag "", id: "recognized-preview-image",
                    class: "preview-image", style: "display:none; max-width:100%;",
                    alt: "撮影画像プレビュー" %>

  </div>

  <% if @recognition_results.present? %>
    <h3>📊 全商品の類似度スコア</h3>
    <table>
      <thead>
        <tr>
          <th>商品画像</th>
          <th>商品名</th>
          <th>スコア</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
        <% @recognition_results.each do |result| %>
          <% product = result[:product] %>
          <tr>
            <td>
              <% if product.image.attached? %>
                <%= image_tag product.image.variant(resize_to_limit: [100,100]), width: "100" %>
              <% else %>
                <span>画像なし</span>
              <% end %>
            </td>
            <td><%= product.name %></td>
            <td><%= "%.3f" % result[:score] %></td> <%# スコアはパーセントではなく、0.000 から 1.000 の形式で表示 %>
            <td>
              <%= button_to "カートに追加", add_to_cart_products_path(recognized_name: product.name), method: :post, class: "btn btn-primary btn-sm" %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% else %>
    <p>認識結果はありませんでした。</p>
  <% end %>


<!-- キャッシュ再構築ボタン（Flask API 叩く） -->
<%# <%= link_to "キャッシュを構築する", build_cache_products_path %> 

  <hr style="margin-top: 1.5rem; margin-bottom: 1.5rem;">

  <!-- 操作ボタン -->
  <%= link_to "撮影をやり直す", camera_products_path(mode: "order"),
              class: "btn btn-blue", style: "margin-top:1.2rem;" %>
  <%= link_to "レジに戻る", new_order_products_path,
              class: "btn btn-gray", style: "margin-top:.6rem;" %>

  <!-- デバッグ用: sessionStorageの内容を表示 -->
  <div style="border: 2px solid red; padding: 10px; margin-top: 20px; background-color: #fdd; color: #333;">
    <p style="font-weight: bold; margin-bottom: 5px;">デバッグ情報 (sessionStorage):</p>
    <p style="font-size: 0.9em; margin-bottom: 3px;">'capturedImage' のキーで保存されているデータ (最初の100文字):</p>
    <pre id="debug-session-storage" style="word-wrap: break-word; white-space: pre-wrap; background-color: #fff; padding: 5px; border: 1px solid #ccc; font-size: 0.8em;"></pre>
  </div>

  <script>
    function displaySessionStorageDebugInfo() {
      const debugElement = document.getElementById('debug-session-storage');
      if (debugElement) {
        const storedData = sessionStorage.getItem('capturedImage');
        if (storedData) {
          debugElement.textContent = storedData.substring(0, 100) + (storedData.length > 100 ? "..." : "");
        } else {
          debugElement.textContent = "sessionStorageに 'capturedImage' は見つかりませんでした。";
        }
      }
    }

    document.addEventListener('DOMContentLoaded', displaySessionStorageDebugInfo);
    // Turbo Drive を使っている場合は turbo:load も考慮
    document.addEventListener('turbo:load', displaySessionStorageDebugInfo);
  </script>
  <!-- デバッグ用ここまで -->
</div>
