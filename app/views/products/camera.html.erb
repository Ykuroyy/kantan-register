<h2 class="form-heading">ğŸ“· ã‚«ãƒ¡ãƒ©ã§æ’®å½±</h2>

<div id="camera-container" data-mode="<%= params[:mode] %>" data-product-id="<%= params[:product_id] %>">
  <!-- ã‚«ãƒ¡ãƒ©æ˜ åƒ -->
  <video id="video" width="320" height="240" autoplay></video>
  <br>

  <!-- æ’®å½±ãƒœã‚¿ãƒ³ -->
  <button id="capture">æ’®å½±ã™ã‚‹</button>

  <!-- ã¾ãŸã¯ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã§äºˆæ¸¬ -->
  <% if params[:mode] == "order" %>
    <h3>ã¾ãŸã¯ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰äºˆæ¸¬</h3>
    <input type="file" id="upload-file" accept="image/*">
    <button id="predict-button">ã“ã®ç”»åƒã§äºˆæ¸¬</button>
  <% end %>

  <!-- Canvasã¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
  <canvas id="canvas" width="320" height="240" style="visibility:hidden;"></canvas>
  <img id="preview" style="margin-top:10px; max-width:320px; display:none;" alt="æ’®å½±ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">

  <!-- çµæœè¡¨ç¤º -->
  <p id="result" style="font-weight:bold; font-size:18px; margin-top:10px;"></p>
</div>

<!-- æˆ»ã‚Šãƒœã‚¿ãƒ³ -->
<% if params[:mode] == "edit" && params[:product_id].present? %>
  <%= link_to "å•†å“ç·¨é›†ã«æˆ»ã‚‹", edit_product_path(params[:product_id]), class: "form-button gray" %>
<% elsif params[:mode] == "new" %>
  <%= link_to "å•†å“ç™»éŒ²ã«æˆ»ã‚‹", new_product_path, class: "form-button gray" %>
<% else %>
  <%= link_to "ãƒ¬ã‚¸ç”»é¢ã«æˆ»ã‚‹", new_order_products_path, class: "form-button gray" %>
<% end %>


<!-- âœ… ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨ã®éš ã—ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆRailsã®ãƒ‘ã‚¹ã‚’ä½¿ã†ï¼‰ -->

 
<form id="camera-upload-form" action="<%= capture_product_products_path %>" method="POST" enctype="multipart/form-data">


  <input type="file" id="image-blob-upload" name="image">
  <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
</form>




<script>
document.addEventListener("DOMContentLoaded", () => {
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const context = canvas.getContext("2d");
  const preview = document.getElementById("preview");
  const resultElem = document.getElementById("result");
  const container = document.getElementById("camera-container");

  if (!video || !canvas || !container) return;

  const mode = container.dataset.mode;
  const productId = container.dataset.productId;




  // ã‚«ãƒ¡ãƒ©èµ·å‹•
  navigator.mediaDevices.getUserMedia({ video: true })
    .then((stream) => {
      video.srcObject = stream;
    })
    .catch((err) => {
      alert("ã‚«ãƒ¡ãƒ©ãŒä½¿ç”¨ã§ãã¾ã›ã‚“: " + err.message);
      console.error(err);
    });

  // æ’®å½±å‡¦ç†
  // document.getElementById("capture").addEventListener("click", () => {
      
  const captureButton = document.getElementById("capture");
  captureButton.addEventListener("click", () => {
    context.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imageDataUrl = canvas.toDataURL("image/png");
    preview.src = imageDataUrl;
    preview.style.display = "block";

    // âœ… æ’®å½±ç”»åƒã‚’ä¿å­˜ï¼ˆæ¬¡ã®ç”»é¢ã§ä½¿ã†ï¼‰
    sessionStorage.setItem("capturedImage", imageDataUrl);

    canvas.toBlob((blob) => {
      if (mode === "new" || mode === "edit") {
        sendImageToRails(blob);
      } else {
        sendImageToPredict(blob);
      }
    }, "image/png");
  });

  // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ â†’ Flaskã¸é€ä¿¡
  const predictBtn = document.getElementById("predict-button");
  if (predictBtn) {
    predictBtn.addEventListener("click", () => {
      const file = document.getElementById("upload-file").files[0];
      if (!file) {
        alert("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„");
        return;
      }
      sendImageToPredict(file);
    });
  }

  // Railsã¸é€ä¿¡ï¼ˆç™»éŒ²ï¼‰
  function sendImageToRails(blob) {
    const formData = new FormData();
    formData.append("image", blob, "photo.png");

    fetch("/products/capture_product", {
      method: "POST",
      body: formData,
    }).then(() => {
      if (mode === "new") {
        window.location.href = "/products/new?from_camera=1";
      } else {
        window.location.href = `/products/${productId}/edit?from_camera=1`;
      }
    });
  }

  // Flaskã¸ç”»åƒã‚’é€ä¿¡ï¼ˆäºˆæ¸¬ï¼‰
  function sendImageToPredict(blob) {
    const formData = new FormData();
    formData.append("image", blob, "photo.png");

    // âœ… Flaskã®URLã‚’è‡ªå‹•ã§åˆ‡ã‚Šæ›¿ãˆã‚‹
    const isLocalhost = location.hostname === "localhost" || location.hostname === "127.0.0.1";
    const baseFlaskUrl = isLocalhost
      ? "http://localhost:10000"
      : "https://ai-server-f6si.onrender.com";

    const pingUrl = `${baseFlaskUrl}/ping`;
    const predictUrl = `${baseFlaskUrl}/predict`;

    // ğŸ” ã‚¹ãƒªãƒ¼ãƒ—å¯¾ç­–ï¼šã¾ãšping
    fetch(pingUrl)
      .finally(() => {
        // pingå®Œäº†å¾Œã«äºˆæ¸¬å‡¦ç†
        fetch(predictUrl, {
          method: "POST",
          body: formData,
        })
        .then((response) => response.json())
        .then((json) => {
          if (json.name) {
            const url = `/products/predict_result?predicted_name=${encodeURIComponent(json.name)}&score=${json.score}`;
            window.location.href = url;
          } else {
            resultElem.textContent = "ä¸€è‡´ã™ã‚‹å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ";
            resultElem.style.color = "red";
          }
        })
        .catch((error) => {
          resultElem.textContent = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + error.message;
          resultElem.style.color = "red";
        });
      });
 }
}); 
</script>