<%= link_to "ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹", root_path, class: "form-button gray" %>
<h2 class="form-heading">ğŸ“· ã‚«ãƒ¡ãƒ©ã§æ’®å½±</h2>

<div id="camera-container" data-mode="<%= params[:mode] %>" data-product-id="<%= params[:product_id] %>" class="form-container">
  <div class="form-card">
    <!-- ãƒ©ã‚¤ãƒ–ã‚«ãƒ¡ãƒ©æ˜ åƒ -->
    <%# <video id="video" autoplay style="max-width:100%; height:auto; margin-bottom:16px;"></video> %>
    
    <!-- âœ… iOS å¯¾å¿œã® playsinline ã¨ muted ã‚’è¿½åŠ  -->
    <video id="video"
          autoplay
          playsinline
          muted
          style="max-width:100%; height:auto; margin-bottom:16px;"></video>




    <!-- ãƒœã‚¿ãƒ³ç¾¤ -->
    <div class="form-actions" style="justify-content:center; margin-bottom:16px;">
      <button id="capture" class="form-button blue" type="button" style="margin-right:8px;">æ’®å½±ã™ã‚‹</button>
    </div>

    <!-- æˆ»ã‚‹ãƒªãƒ³ã‚¯ -->
    <div style="text-align:center; margin-top:16px;">
      <% if params[:mode] == "edit" && params[:product_id].present? %>
        <%= link_to "å•†å“ç·¨é›†ã«æˆ»ã‚‹", edit_product_path(params[:product_id]), class: "form-button gray" %>
      <% elsif params[:mode] == "new" %>
        <%= link_to "å•†å“ç™»éŒ²ã«æˆ»ã‚‹", new_product_path, class: "form-button gray" %>
      <% else %>
        <%= link_to "ãƒ¬ã‚¸ç”»é¢ã«æˆ»ã‚‹", new_order_products_path, class: "form-button gray" %>
      <% end %>
    </div>
  </div>
</div>    


<script>
  document.addEventListener("DOMContentLoaded", () => {
    const video      = document.getElementById("video");
    const captureBtn = document.getElementById("capture");
    const fileInput  = document.getElementById("upload-file");
    const preview    = document.getElementById("camera-preview-image");
    const container  = document.getElementById("camera-container");
    if (!video || !captureBtn || !container) return;

    // ã‚«ãƒ¡ãƒ©èµ·å‹•
    // navigator.mediaDevices.getUserMedia({ video: true })
      // .then(stream => video.srcObject = stream)
      // .catch(err => console.error("ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼:", err));

    // --- èƒŒé¢ã‚«ãƒ¡ãƒ©å„ªå…ˆã§èµ·å‹• --------------------------------
    let stream;  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿æŒ

    async function startCamera(tryDeviceId = false) {
      if (stream) stream.getTracks().forEach(t => t.stop()); // æ—¢å­˜ã‚¹ãƒˆãƒªãƒ¼ãƒ è§£æ”¾

      try {
        // â‘  facingMode ã§èƒŒé¢ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        const constraints = tryDeviceId
          ? await rearCameraByDeviceId()      // â‘¡ deviceId ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          : { video: { facingMode: { exact: "environment" } }, audio: false };

        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
      } catch (err) {
        // â‘  å¤±æ•— â†’ â‘¡ ã‚’è©¦ã™
        if (!tryDeviceId) return startCamera(true);
        console.error("èƒŒé¢ã‚«ãƒ¡ãƒ©å–å¾—ã«å¤±æ•—:", err);
        alert("èƒŒé¢ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸ");
      }
    }

    // èƒŒé¢ã‚«ãƒ¡ãƒ©ã‚‰ã—ã deviceId ã‚’é¸ã¶
    async function rearCameraByDeviceId() {
      // label ã‚’å¾—ã‚‹ãŸã‚ã«ä¸€åº¦ã ã‘æ¨©é™å–å¾—
      await navigator.mediaDevices.getUserMedia({ video: true, audio: false });

      const devices = await navigator.mediaDevices.enumerateDevices();
      const rearCam = devices.find(d =>
        d.kind === "videoinput" && /back|rear|environment/i.test(d.label)
      );

      if (rearCam) {
        return { video: { deviceId: { exact: rearCam.deviceId } }, audio: false };
      }
      // è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°é€šå¸¸ã‚«ãƒ¡ãƒ©
      return { video: true, audio: false };
    }

    // DOMContentLoaded æ™‚ç‚¹ã§èµ·å‹•
    startCamera();

    // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã«ã‚¹ãƒˆãƒªãƒ¼ãƒ è§£æ”¾ï¼ˆiOS é»’ç”»é¢ãƒã‚°å¯¾ç­–ï¼‰
    window.addEventListener("pagehide", () => {
      if (stream) stream.getTracks().forEach(t => t.stop());
    });
    // ----------------------------------------------------------










    const mode      = container.dataset.mode;
    const productId = container.dataset.productId;
    const isLocal   = ["localhost","127.0.0.1"].includes(location.hostname);
    const flaskUrl  = isLocal ? "http://localhost:10000" : "https://ai-server-f6si.onrender.com";

    // æ’®å½±/é€ä¿¡å‡¦ç†
    function sendCapture(blob) {
      const fd = new FormData();
      // fd.append("image", blob, "capture.png");
      if (mode === "order") {
        fetch(`${flaskUrl}/predict`, { method: "POST", body: fd })
          .then(res => res.json())
          .then(json => {
            const name  = json.name || '';
            const score = json.score || 0;
            window.location.href = `/products/predict_result?predicted_name=${encodeURIComponent(name)}&score=${score}`;
          })
          .catch(err => console.error("äºˆæ¸¬ã‚¨ãƒ©ãƒ¼:", err));
      } else {
        fetch("/products/capture_product", { method: "POST", body: fd })
          .then(() => {
            const url = mode === "new"
              ? "/products/new?from_camera=1"
              : `/products/${productId}/edit?from_camera=1`;
            window.location.href = url;
          })
          .catch(err => console.error("é€ä¿¡ã‚¨ãƒ©ãƒ¼:", err));
      }
    }

    // ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
    captureBtn.addEventListener("click", () => {
      // const canvas = document.createElement("canvas");
      // canvas.width  = video.videoWidth;
      // canvas.height = video.videoHeight;
      // canvas.getContext("2d").drawImage(video, 0, 0);
      
    // Base64 ãƒ‡ãƒ¼ã‚¿ URL ã‚’å–å¾—ã—ã¦ä¿å­˜
    // const dataUrl = canvas.toDataURL("image/png");
    // sessionStorage.setItem("capturedImage", dataUrl);


    // Blob å¤‰æ›ã—ã¦é€ä¿¡
    // canvas.toBlob(blob => sendCapture(blob), "image/png");
  // });
     /* ===== âœ… ãƒªã‚µã‚¤ã‚ºä»˜ãã‚­ãƒ£ãƒ—ãƒãƒ£ (MAX 512px, JPEG 85%) ===== */
      const MAX = 512;                                       // æœ€é•·è¾ºã®ä¸Šé™
      const scale = Math.min(
        MAX / video.videoWidth,
        MAX / video.videoHeight,
        1                                // ã™ã§ã«å°ã•ã„å ´åˆã¯ç­‰å€
      );
    
      const canvas = document.createElement("canvas");
      canvas.width  = Math.round(video.videoWidth  * scale);
      canvas.height = Math.round(video.videoHeight * scale);
    
      canvas
        .getContext("2d")
        .drawImage(
          video,
          0, 0, video.videoWidth, video.videoHeight,  // å…ƒã‚µã‚¤ã‚º
          0, 0, canvas.width,    canvas.height       // ãƒªã‚µã‚¤ã‚ºå¾Œ
        );
    
      // ğŸ‘€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¿å­˜ (ä»»æ„)
      const dataUrl = canvas.toDataURL("image/jpeg", 0.85);
      sessionStorage.setItem("capturedImage", dataUrl);
    
      // Blob åŒ–ã—ã¦é€ä¿¡ï¼ˆæ—¢å­˜ã® sendCapture ã‚’ãã®ã¾ã¾åˆ©ç”¨ï¼‰
      // canvas.toBlob(blob => sendCapture(blob), "image/jpeg", 0.85);
      canvas.toBlob(blob => sendCapture(blob), "image/png");

    });


 
});
</script>
