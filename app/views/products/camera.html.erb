<%= link_to "ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹", root_path, class: "form-button gray" %>
<h2 class="form-heading">ğŸ“· ã‚«ãƒ¡ãƒ©ã§æ’®å½±</h2>

<div id="camera-container" data-mode="<%= params[:mode] %>" data-product-id="<%= params[:product_id] %>" class="form-container">
  <div class="form-card">
    <!-- ãƒ©ã‚¤ãƒ–ã‚«ãƒ¡ãƒ©æ˜ åƒ -->
    <%# <video id="video" autoplay style="max-width:100%; height:auto; margin-bottom:16px;"></video> %>
    
    <!-- âœ… iOS å¯¾å¿œã® playsinline ã¨ muted ã‚’è¿½åŠ  -->
    <video id="video"
          autoplay
          playsinline
          muted
          style="max-width:100%; height:auto; margin-bottom:16px;"></video>




    <!-- ãƒœã‚¿ãƒ³ç¾¤ -->
    <div class="form-actions" style="justify-content:center; margin-bottom:16px;">
      <button id="capture" class="form-button blue" type="button" style="margin-right:8px;">æ’®å½±ã™ã‚‹</button>
    </div>

    <!-- æˆ»ã‚‹ãƒªãƒ³ã‚¯ -->
    <div style="text-align:center; margin-top:16px;">
      <% if params[:mode] == "edit" && params[:product_id].present? %>
        <%= link_to "å•†å“ç·¨é›†ã«æˆ»ã‚‹", edit_product_path(params[:product_id]), class: "form-button gray" %>
      <% elsif params[:mode] == "new" %>
        <%= link_to "å•†å“ç™»éŒ²ã«æˆ»ã‚‹", new_product_path, class: "form-button gray" %>
      <% else %>
        <%= link_to "ãƒ¬ã‚¸ç”»é¢ã«æˆ»ã‚‹", new_order_products_path, class: "form-button gray" %>
      <% end %>
    </div>
  </div>
</div>    


<script>
  document.addEventListener("DOMContentLoaded", () => {
    const video      = document.getElementById("video");
    const captureBtn = document.getElementById("capture");
    const fileInput  = document.getElementById("upload-file");
    const preview    = document.getElementById("camera-preview-image");
    const container  = document.getElementById("camera-container");
    if (!video || !captureBtn || !container) return;

    // ã‚«ãƒ¡ãƒ©èµ·å‹•
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => video.srcObject = stream)
      .catch(err => console.error("ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼:", err));

    const mode      = container.dataset.mode;
    const productId = container.dataset.productId;
    const isLocal   = ["localhost","127.0.0.1"].includes(location.hostname);
    const flaskUrl  = isLocal ? "http://localhost:10000" : "https://ai-server-f6si.onrender.com";

    // æ’®å½±/é€ä¿¡å‡¦ç†
    function sendCapture(blob) {
      const fd = new FormData();
      fd.append("image", blob, "capture.png");
      if (mode === "order") {
        fetch(`${flaskUrl}/predict`, { method: "POST", body: fd })
          .then(res => res.json())
          .then(json => {
            const name  = json.name || '';
            const score = json.score || 0;
            window.location.href = `/products/predict_result?predicted_name=${encodeURIComponent(name)}&score=${score}`;
          })
          .catch(err => console.error("äºˆæ¸¬ã‚¨ãƒ©ãƒ¼:", err));
      } else {
        fetch("/products/capture_product", { method: "POST", body: fd })
          .then(() => {
            const url = mode === "new"
              ? "/products/new?from_camera=1"
              : `/products/${productId}/edit?from_camera=1`;
            window.location.href = url;
          })
          .catch(err => console.error("é€ä¿¡ã‚¨ãƒ©ãƒ¼:", err));
      }
    }

    // ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
    captureBtn.addEventListener("click", () => {
      const canvas = document.createElement("canvas");
      canvas.width  = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext("2d").drawImage(video, 0, 0);
      
    // Base64 ãƒ‡ãƒ¼ã‚¿ URL ã‚’å–å¾—ã—ã¦ä¿å­˜
    const dataUrl = canvas.toDataURL("image/png");
    sessionStorage.setItem("capturedImage", dataUrl);


    // Blob å¤‰æ›ã—ã¦é€ä¿¡
    canvas.toBlob(blob => sendCapture(blob), "image/png");
  });

 
});
</script>
