<h2 class="form-heading">ğŸ“· ã‚«ãƒ¡ãƒ©ã§æ’®å½±</h2>

<!-- ã‚³ãƒ³ãƒ†ãƒŠã« mode ã¨ product_id ã‚’åŸ‹ã‚è¾¼ã‚€ -->
<div id="camera-container" data-mode="<%= params[:mode] %>" data-product-id="<%= params[:product_id] %>">

  <!-- æ˜ åƒè¡¨ç¤º -->
  <video id="video" width="320" height="240" autoplay></video>
  <br>

  <!-- æ’®å½±ãƒœã‚¿ãƒ³ -->
  <button id="capture">æ’®å½±ã™ã‚‹</button>

  <!-- ã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ -->
  <h3>ã¾ãŸã¯ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰äºˆæ¸¬</h3>
  <input type="file" id="upload-file" accept="image/*">
  <button id="predict-button">ã“ã®ç”»åƒã§äºˆæ¸¬</button>

  <!-- æ’®å½±çµæœã‚’canvasã«æç”»ï¼ˆé€ä¿¡ã«ä½¿ã†ï¼‰ -->
  <canvas id="canvas" width="320" height="240" style="visibility:hidden;"></canvas>


  <!-- çµæœè¡¨ç¤º -->
  <p id="result" style="font-weight:bold; font-size:18px; margin-top:10px;"></p>
</div>



<script>
  document.addEventListener("DOMContentLoaded", () => {
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const context = canvas.getContext("2d");
    const resultElem = document.getElementById("result");
    const container = document.getElementById("camera-container");

    const mode = container.dataset.mode;
    const productId = container.dataset.productId;

    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
      navigator.mediaDevices.getUserMedia({ video: true })
        .then((stream) => {
          video.srcObject = stream;
        })
        .catch((err) => {
          alert("ã‚«ãƒ¡ãƒ©ãŒä½¿ç”¨ã§ãã¾ã›ã‚“: " + err);
        });
    }

    document.getElementById("capture").addEventListener("click", () => {
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      canvas.toBlob((blob) => {
        sendImageToPredict(blob);
      }, "image/png");
    });

    document.getElementById("predict-button").addEventListener("click", () => {
      const file = document.getElementById("upload-file").files[0];
      if (!file) {
        alert("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„");
        return;
      }
      sendImageToPredict(file);
    });




  function sendImageToPredict(blob) {
    resultElem.textContent = "ç”»åƒã‚’èªè­˜ä¸­ã§ã™...";
    resultElem.style.color = "gray";

    const formData = new FormData();
    formData.append("image", blob, "photo.png");

    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute("content");

    // Flaskäºˆæ¸¬APIã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆRailsã®/predictã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
    const endpoint = "/image_predict";

    fetch(endpoint, {
      method: "POST",
      body: formData,
      headers: {
        "X-CSRF-Token": csrfToken
      },
      credentials: "same-origin"
    })
    .then(response => {
      if (!response.ok) throw new Error("ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ï¼š" + response.status);
      return response.text(); // â˜… HTMLã¨ã—ã¦å—ã‘å–ã‚‹ï¼ˆpredict_result.html.erbï¼‰
    })
    .then(html => {
      document.open();
      document.write(html);
      document.close();
    })
    .catch(error => {
      resultElem.textContent = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + error.message;
      resultElem.style.color = "red";
    });
  }

      
</script>




   


      
  



<!-- æˆ»ã‚Šå…ˆãƒœã‚¿ãƒ³ -->
<% if params[:mode] == "edit" && params[:product_id].present? %>
  <%= link_to "å•†å“ç·¨é›†ã«æˆ»ã‚‹", edit_product_path(params[:product_id]), class: "form-button gray" %>
<% elsif params[:mode] == "new" %>
  <%= link_to "å•†å“ç™»éŒ²ã«æˆ»ã‚‹", new_product_path, class: "form-button gray" %>
<% else %>
  <%= link_to "ãƒ¬ã‚¸ç”»é¢ã«æˆ»ã‚‹", new_order_path, class: "form-button gray" %>
<% end %>
