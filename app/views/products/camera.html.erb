<h2>ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦å•†å“ã‚’æ’®å½±</h2>

<!-- æ˜ åƒè¡¨ç¤º -->
<video id="video" width="320" height="240" autoplay></video>
<br>

<!-- æ’®å½±ãƒœã‚¿ãƒ³ -->
<button id="capture">æ’®å½±ã™ã‚‹</button>

<!-- ã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ -->
<h3>ã¾ãŸã¯ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰äºˆæ¸¬</h3>
<input type="file" id="upload-file" accept="image/*">
<button id="predict-button">ã“ã®ç”»åƒã§äºˆæ¸¬</button>

<!-- æ’®å½±çµæœã‚’canvasã«æç”»ï¼ˆé€ä¿¡ã«ä½¿ã†ï¼‰ -->
<canvas id="canvas" width="320" height="240" style="display:none;"></canvas>

<!-- çµæœè¡¨ç¤º -->
<p id="result" style="font-weight:bold; font-size:18px; margin-top:10px;"></p>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const video = document.getElementById("video");

    // ã‚«ãƒ¡ãƒ©èµ·å‹•
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
      navigator.mediaDevices.getUserMedia({ video: true })
        .then((stream) => {
          video.srcObject = stream;
        })
        .catch((err) => {
          alert("ã‚«ãƒ¡ãƒ©ãŒä½¿ç”¨ã§ãã¾ã›ã‚“: " + err);
        });
    } else {
      alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ã‚«ãƒ¡ãƒ©ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
    }

    // ğŸ“¸ æ’®å½±ãƒœã‚¿ãƒ³å‡¦ç†
    document.getElementById("capture").addEventListener("click", () => {
      const canvas = document.getElementById("canvas");
      const context = canvas.getContext("2d");
      context.drawImage(video, 0, 0, canvas.width, canvas.height);

      canvas.toBlob((blob) => {
        sendImageToPredict(blob);
      }, "image/png");
    });




    // ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‹ã‚‰é€ä¿¡
    document.getElementById("predict-button").addEventListener("click", () => {
      const fileInput = document.getElementById("upload-file");
      const file = fileInput.files[0];
      if (!file) {
        alert("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„");
        return;
      }
      sendImageToPredict(file);
    });

    // ğŸ” å…±é€šã®é€ä¿¡å‡¦ç†

    function sendImageToPredict(blob) {
      const formData = new FormData();
      formData.append("image", blob, "photo.png");

      const mode = "<%= params[:mode] %>";
      const productId = "<%= params[:product_id] %>";
      const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute("content");

      let endpoint = "";
      if (mode === "order") {
        endpoint = "/image_predict";
      } else {
        endpoint = `/camera/capture_product?mode=${mode}${productId ? `&product_id=${productId}` : ""}`;
      }

      fetch(endpoint, {
        method: "POST",
        body: formData,
        headers: {
          "X-CSRF-Token": csrfToken
        },
        credentials: "same-origin"
      })
      .then(response => {
        if (mode === "order") {
          return response.json();
        } else {
          // å•†å“ç™»éŒ²ãŒå®Œäº†ã—ãŸã‚‰ã€ç™»éŒ²ç”»é¢ã«æˆ»ã‚‹
          window.location.href = (
            mode === "edit" && productId
              ? `/products/${productId}/edit`
              : "/products/new"
          );
        }
      })
      .then(data => {
        if (mode === "order" && data) {
          const resultElem = document.getElementById("result");
          resultElem.style.display = "block";
          if (data.name) {
            resultElem.textContent = `èªè­˜ã•ã‚ŒãŸå•†å“å: ${data.name}`;
            resultElem.style.color = "black";
            window.location.href = "/orders/new?recognized_name=" + encodeURIComponent(data.name);
          } else {
            resultElem.textContent = "èªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚";
            resultElem.style.color = "red";
          }
        }
      })
      .catch((error) => {
        alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + error);
      });
    }
  });
</script>



<!-- æˆ»ã‚Šå…ˆãƒœã‚¿ãƒ³ -->
<% if params[:mode] == "edit" && params[:product_id].present? %>
  <%= link_to "å•†å“ç·¨é›†ã«æˆ»ã‚‹", edit_product_path(params[:product_id]), class: "form-button gray" %>
<% elsif params[:mode] == "new" %>
  <%= link_to "å•†å“ç™»éŒ²ã«æˆ»ã‚‹", new_product_path, class: "form-button gray" %>
<% else %>
  <%= link_to "ãƒ¬ã‚¸ç”»é¢ã«æˆ»ã‚‹", new_order_path, class: "form-button gray" %>
<% end %>
