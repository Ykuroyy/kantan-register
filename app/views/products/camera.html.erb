<div class="container" id="camera-container"
     data-mode="<%= params[:mode] %>"
     data-product-id="<%= params[:product_id] %>">

  <!-- ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹ -->
  <%= link_to "ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹", root_path, class: "btn btn-gray" %>

  <h2 class="form-heading">ğŸ“· ã‚«ãƒ¡ãƒ©ã§æ’®å½±</h2>

  <!-- ãƒ©ã‚¤ãƒ–ã‚«ãƒ¡ãƒ©ã‚«ãƒ¼ãƒ‰ -->
  <div class="card">

    <!-- ãƒ©ã‚¤ãƒ–æ˜ åƒ -->
    <video id="video"
           autoplay
           playsinline
           muted
           style="max-width:100%; height:auto; border-radius:12px; margin-bottom:1rem;"></video>

    <!-- æ’®å½±ãƒœã‚¿ãƒ³ -->
    <div style="text-align:center; margin-bottom:1rem;">
      <button id="capture" type="button" class="btn btn-blue">æ’®å½±ã™ã‚‹</button>
    </div>

    <!-- æˆ»ã‚‹ãƒªãƒ³ã‚¯ç¾¤ -->
    <div style="text-align:center; margin-top:1rem; display:flex; gap:.6rem; flex-wrap:wrap; justify-content:center;">
      <% if params[:mode] == "edit" && params[:product_id].present? %>
        <%= link_to "å•†å“ç·¨é›†ã«æˆ»ã‚‹", edit_product_path(params[:product_id]), class: "btn btn-gray" %>
      <% elsif params[:mode] == "new" %>
        <%= link_to "å•†å“ç™»éŒ²ã«æˆ»ã‚‹", new_product_path, class: "btn btn-gray" %>
      <% else %>
        <%= link_to "ãƒ¬ã‚¸ç”»é¢ã«æˆ»ã‚‹", new_order_products_path, class: "btn btn-gray" %>
      <% end %>
    </div>
  </div>
</div>


<script>
document.addEventListener("DOMContentLoaded", () => {
  const video      = document.getElementById("video");
  const captureBtn = document.getElementById("capture");
  const container  = document.getElementById("camera-container");
  if (!video || !captureBtn || !container) return;

  /* --- èƒŒé¢ã‚«ãƒ¡ãƒ©å„ªå…ˆã§èµ·å‹• ----------------------------- */
  let stream;
  async function startCamera(tryDeviceId = false) {
    if (stream) stream.getTracks().forEach(t => t.stop());
    try {
      const constraints = tryDeviceId
        ? await rearCameraByDeviceId()
        : { video: { facingMode: { exact: "environment" } }, audio: false };
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;
    } catch (err) {
      // if (!tryDeviceId) return startCamera(true);
      // console.error("èƒŒé¢ã‚«ãƒ¡ãƒ©å–å¾—ã«å¤±æ•—:", err);
      // alert("èƒŒé¢ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸ");


      // â˜… â‘  ãƒ‡ãƒã‚¤ã‚¹IDã§èƒŒé¢ã‚«ãƒ¡ãƒ©å†è©¦è¡Œ
      if (!tryDeviceId) return startCamera(true);

      console.warn("rear camera not found, fallback to front:", err);
      // â˜… â‘¡ ãã‚Œã§ã‚‚å¤±æ•—ã—ãŸã‚‰ front-cameraï¼ˆPC ç”¨ï¼‰ã¸ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      try {
        const frontStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "user" },
          audio: false,
        });
        stream = frontStream;
        video.srcObject = stream;
        console.log("âœ… front camera");
      } catch (e) {
        console.error("front camera ã‚‚å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ:", e);
        alert("ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸ");
      }
    }
  }
  async function rearCameraByDeviceId() {
    await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
    const devices = await navigator.mediaDevices.enumerateDevices();
    const rearCam = devices.find(d =>
      d.kind === "videoinput" && /back|rear|environment/i.test(d.label)
    );
    return rearCam
      ? { video: { deviceId: { exact: rearCam.deviceId } }, audio: false }
      : { video: true, audio: false };
  }
  startCamera();
  window.addEventListener("pagehide", () => {
    if (stream) stream.getTracks().forEach(t => t.stop());
  });
  /* ------------------------------------------------------- */

  const mode      = container.dataset.mode;
  const productId = container.dataset.productId;
  const flaskUrl  = ["localhost","127.0.0.1"].includes(location.hostname)
                    ? "http://localhost:10000"
                    : "https://ai-server-f6si.onrender.com";

  function sendCapture(blob) {
    const fd = new FormData();
    fd.append("image", blob, "capture.png");           // PNG é€ä¿¡

    if (mode === "order") {
      fetch(`${flaskUrl}/predict`, { method: "POST", body: fd })
        .then(res => res.json())
        .then(json => {
          const name  = json.name  || '';
          const score = json.score || 0;
          window.location.href =
            `/products/predict_result?predicted_name=${encodeURIComponent(name)}&score=${score}`;
        })
        .catch(err => console.error("äºˆæ¸¬ã‚¨ãƒ©ãƒ¼:", err));
    } else {
      fetch("/products/capture_product", { method: "POST", body: fd })
        .then(() => {
          const url = mode === "new"
                     ? "/products/new?from_camera=1"
                     : `/products/${productId}/edit?from_camera=1`;
          window.location.href = url;
        })
        .catch(err => console.error("é€ä¿¡ã‚¨ãƒ©ãƒ¼:", err));
    }
  }

  /* ===== ãƒªã‚µã‚¤ã‚ºä»˜ãã‚­ãƒ£ãƒ—ãƒãƒ£  ===== */
  captureBtn.addEventListener("click", () => {
    const MAX   = 640;
    const scale = Math.min(MAX / video.videoWidth,
                           MAX / video.videoHeight, 1);

    const canvas = document.createElement("canvas");
    canvas.width  = Math.round(video.videoWidth  * scale);
    canvas.height = Math.round(video.videoHeight * scale);
    canvas.getContext("2d").drawImage(
      video, 0, 0, video.videoWidth, video.videoHeight,
      0, 0, canvas.width, canvas.height
    );


    const dataUrl = canvas.toDataURL("image/jpeg", 0.80);  // 80% å“è³ªã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
    sessionStorage.setItem("capturedImage", dataUrl);


    canvas.toBlob(
      blob => sendCapture(blob),
     "image/jpeg",
     0.80                                     // é€ä¿¡ã‚‚ 80% å“è³ª
    );

  });
});
</script>
