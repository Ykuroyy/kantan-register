<div class="container" id="camera-container"
     data-mode="<%= params[:mode] %>"
     data-product-id="<%= params[:product_id] %>">

  <!-- ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹ -->
  <%= link_to "ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹", root_path, class: "btn btn-gray" %>

  <h2 class="form-heading">ğŸ“· ã‚«ãƒ¡ãƒ©ã§æ’®å½±</h2>

  <!-- ãƒ©ã‚¤ãƒ–ã‚«ãƒ¡ãƒ©ã‚«ãƒ¼ãƒ‰ -->
  <div class="card">

    <!-- ãƒ©ã‚¤ãƒ–æ˜ åƒ -->
    <video id="video"
           autoplay
           playsinline
           muted
           style="max-width:100%; height:auto; border-radius:12px; margin-bottom:1rem;"></video>

    <!-- èµ·å‹•ï¼†æ’®å½±ãƒœã‚¿ãƒ³ -->
    <div style="text-align:center; margin-bottom:1rem; display:flex; gap:.6rem; justify-content:center;">
      <button id="start-camera" type="button" class="btn btn-blue">ã‚«ãƒ¡ãƒ©èµ·å‹•</button>
      <button id="capture-photo" type="button" class="btn btn-yellow">æ’®å½±ã™ã‚‹</button>
    </div>

    <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º -->
    <img id="preview" style="display:none; max-width:100%; border-radius:12px; margin-bottom:1rem;" />

    <!-- æˆ»ã‚‹ãƒªãƒ³ã‚¯ç¾¤ -->
    <div style="text-align:center; margin-top:1rem; display:flex; gap:.6rem; flex-wrap:wrap; justify-content:center;">
      <% if params[:mode] == "edit" && params[:product_id].present? %>
        <%= link_to "å•†å“ç·¨é›†ã«æˆ»ã‚‹", edit_product_path(params[:product_id]), class: "btn btn-gray" %>
      <% elsif params[:mode] == "new" %>
        <%= link_to "å•†å“ç™»éŒ²ã«æˆ»ã‚‹", new_product_path, class: "btn btn-gray" %>
      <% else %>
        <%= link_to "ãƒ¬ã‚¸ç”»é¢ã«æˆ»ã‚‹", new_order_products_path, class: "btn btn-gray" %>
      <% end %>
    </div>
  </div>

  <!-- hidden canvas for capture -->
  <canvas id="canvas" style="display:none;"></canvas>
</div>

<script>
document.addEventListener("turbo:load", () => {
  const video      = document.getElementById("video");
  const startBtn   = document.getElementById("start-camera");
  const captureBtn = document.getElementById("capture-photo");
  const canvas     = document.getElementById("canvas");
  const ctx        = canvas.getContext("2d");
  const preview    = document.getElementById("preview");
  const container  = document.getElementById("camera-container");

  if (!video || !startBtn || !captureBtn || !canvas || !container) return;

  const mode      = container.dataset.mode;
  const productId = container.dataset.productId;

  // ã‚¹ãƒãƒ›ã‹ã©ã†ã‹ã‚’ç°¡æ˜“åˆ¤å®š
  const isMobile = /Mobi|Android/i.test(navigator.userAgent);
  const constraints = isMobile
    ? { video: { facingMode: { ideal: "environment" } }, audio: false }  // ã‚¹ãƒãƒ›ãªã‚‰èƒŒé¢
    : { video: { facingMode: "user" }, audio: false };                   // PCãªã‚‰ã‚¤ãƒ³ã‚«ãƒ¡ãƒ©

  // ã‚«ãƒ¡ãƒ©èµ·å‹•ï¼ˆãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ï¼‰
  startBtn.addEventListener("click", async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;
      await video.play();
    } catch (err) {
      alert("ã‚«ãƒ¡ãƒ©ãŒä½¿ç”¨ã§ãã¾ã›ã‚“: " + err.message);
      console.error(err);
    }
  });

  // æ’®å½±å‡¦ç†
  captureBtn.addEventListener("click", () => {
    // Canvas ã®ã‚µã‚¤ã‚ºã‚’ video ã«åˆã‚ã›ã‚‹
    canvas.width  = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    // JPEG å½¢å¼ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼†ä¿å­˜
    const dataUrl = canvas.toDataURL("image/jpeg", 0.8);
    preview.src           = dataUrl;
    preview.style.display = "block";
    sessionStorage.setItem("capturedImage", dataUrl);

    // JPEG å½¢å¼ã§ Blob ã«å¤‰æ›ã—ã¦é€ä¿¡
    canvas.toBlob((blob) => {
      const formData = new FormData();
      formData.append("image", blob, "capture.jpg");

      if (mode === "new" || mode === "edit") {
        fetch("/products/capture_product", { method: "POST", body: formData })
          .then(() => {
            const path = mode === "new"
              ? "/products/new?from_camera=1"
              : `/products/${productId}/edit?from_camera=1`;
            window.location.href = path;
          });
      } else {
        // Flask äºˆæ¸¬ç”¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆåˆ‡ã‚Šæ›¿ãˆ
        const isLocal = ["localhost","127.0.0.1"].includes(location.hostname);
        const baseUrl = isLocal
          ? "http://localhost:10000"
          : "https://ai-server-f6si.onrender.com";
        fetch(`${baseUrl}/predict`, { method: "POST", body: formData })
          .then(res => res.json())
          .then(json => {
            const name  = json.name  || "";
            const score = json.score || 0;
            window.location.href =
              `/products/predict_result?predicted_name=${encodeURIComponent(name)}&score=${score}`;
          })
          .catch(err => {
            console.error("äºˆæ¸¬ã‚¨ãƒ©ãƒ¼:", err);
            alert("äºˆæ¸¬å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ");
          });
      }
    }, "image/jpeg", 0.8);
  });
});
</script>
