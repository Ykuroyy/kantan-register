<h2 class="form-heading">ãƒ¬ã‚¸ç”»é¢</h2>

<div class="form-container">
  <!-- ã‚«ãƒ¡ãƒ©èµ·å‹•ãƒœã‚¿ãƒ³ -->
  <div class="form-card">
    <p class="form-field">ç”»åƒèªè­˜ã§å•†å“ã‚’é¸ã¶</p>
    <%= link_to "ã‚«ãƒ¡ãƒ©ã§æ’®å½±", camera_path, class: "form-button blue" %>

    <p class="form-field">å•†å“åã‹ã‚‰æ¤œç´¢</p>
    <%= form_with url: new_order_path, method: :get, local: true do %>
      <%= text_field_tag :keyword, params[:keyword], placeholder: "ã‚«ã‚¿ã‚«ãƒŠã§å•†å“åã‚’å…¥åŠ›", class: "form-field" %>
      <%= submit_tag "æ¤œç´¢", class: "form-button blue" %>
    <% end %>
  </div>

  <!-- æ‰‹å‹•é¸æŠ -->
  <% @products.each do |product| %>
    <div class="form-card">
      <% if product.image.attached? %>
        <%= image_tag product.image.variant(resize_to_limit: [500, 500]).processed, class: "preview-image" %>

      <% else %>
        <div class="preview-image no-image">ç”»åƒãªã—</div>
      <% end %>

      <div class="form-field">
        <strong>å•†å“å:</strong> <%= product.name %>
      </div>

      <div class="form-field">
        <strong>ä¾¡æ ¼:</strong> Â¥<%= number_with_delimiter(product.price) %>
      </div>

      <%= form_with url: add_to_cart_orders_path, method: :post, local: true do %>
        <%= hidden_field_tag :product_id, product.id %>
        <%= submit_tag "ã‚«ãƒ¼ãƒˆã«è¿½åŠ ", class: "form-button yellow" %>
      <% end %>
    </div>
  <% end %>
</div>

<!-- ğŸ§º ã‚«ãƒ¼ãƒˆã®ä¸­èº« -->
<div class="form-card">
  <p class="form-field">ã‚«ãƒ¼ãƒˆã®ä¸­èº«</p>

  <% if @cart_items.present? %>
    <%= form_with url: update_cart_orders_path, method: :patch, local: true do %>
      <ul>
        <% total = 0 %>
        <% @cart_items.each do |item| %>
          <% product = item[:product] %>
          <% quantity = item[:quantity].to_i %>
          <li>
            <%= product.name %> - Â¥<%= number_with_delimiter(product.price) %>
            Ã—
            <%= number_field_tag "quantities[#{product.id}]", quantity, min: 1, class: "quantity-field", style: "width: 60px;" %>
            <% total += product.price * quantity %>
          </li>
        <% end %>
      </ul>

      <!-- åˆè¨ˆé‡‘é¡ -->
      <p><strong>åˆè¨ˆé‡‘é¡:</strong> Â¥<%= number_with_delimiter(total) %></p>

      <%= submit_tag "æ•°é‡ã‚’æ›´æ–°ã™ã‚‹", class: "form-button yellow" %>
    <% end %>

    <!-- âœ… æ”¯æ‰•ã„ãƒœã‚¿ãƒ³ -->
    <%= button_to "æ”¯æ‰•ã„", orders_path, method: :post, class: "form-button blue" %>

    <!-- ğŸ” ã‚«ãƒ¼ãƒˆã‚’ç©ºã«ã™ã‚‹ -->
    <%= button_to "ã‚«ã‚´ã‚’ç©ºã«ã™ã‚‹", clear_cart_orders_path, method: :post, class: "form-button red" %>

    <!-- ğŸ”™ ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹ -->
    <%= link_to "ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹", root_path, class: "form-button gray" %>
  <% else %>
    <p>ã‚«ãƒ¼ãƒˆã«å•†å“ã¯ã‚ã‚Šã¾ã›ã‚“</p>
  <% end %>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const productName = localStorage.getItem("recognizedProductName");
    if (productName) {
      localStorage.removeItem("recognizedProductName");
      const encoded = encodeURIComponent(productName);
      window.location.href = `/orders/new?recognized=${encoded}`;
    }
  });
</script>

