<h2 class="form-heading">レジ画面</h2>

<div class="form-container">
  <!-- カメラ起動ボタン -->
  <div class="form-card">
    <p class="form-field">画像認識で商品を選ぶ</p>
    <%= link_to "カメラで撮影", camera_path(mode: "order"), class: "form-button blue" %>



    <p class="form-field">商品名から検索</p>
    <%= form_with url: new_order_path, method: :get, local: true do %>
      <%= text_field_tag :keyword, params[:keyword], placeholder: "カタカナで商品名を入力", class: "form-field" %>
      <%= submit_tag "検索", class: "form-button blue" %>
    <% end %>
  </div>

  <!-- 手動選択 -->
  <% @products.each do |product| %>
    <div class="form-card">
      <% if product.image.attached? %>
        <%= image_tag product.image.variant(resize_to_limit: [500, 500]).processed, class: "preview-image" %>
      <% else %>
        <div class="preview-image no-image">画像なし</div>
      <% end %>

      <div class="form-field">
        <strong>商品名:</strong> <%= product.name %>
      </div>

      <div class="form-field">
        <strong>価格:</strong> ¥<%= number_with_delimiter(product.price) %>
      </div>

      <%= form_with url: add_to_cart_orders_path, method: :post, local: true do %>
        <%= hidden_field_tag :product_id, product.id %>
        <%= submit_tag "カートに追加", class: "form-button yellow" %>
      <% end %>
    </div>
  <% end %>
</div>

<!-- 🧺 カートの中身 -->
<div class="form-card">
  <p class="form-field">カートの中身</p>

  <% if @cart_items.present? %>
    <%= form_with url: update_cart_orders_path, method: :patch, local: true do %>
      <ul>
        <% total = 0 %>
        <% @cart_items.each do |item| %>
          <% product = item[:product] %>
          <% quantity = item[:quantity].to_i %>
          <li style="margin-bottom: 1em;">
            <%= product.name %> - ¥<%= number_with_delimiter(product.price) %>
            ×
            <%= number_field_tag "quantities[#{product.id}]", quantity, min: 0, class: "quantity-field", style: "width: 60px;" %>

            <!-- 🔁 数量更新 -->
            <%= submit_tag "数量を更新", class: "form-button yellow", name: "commit_#{product.id}" %>

  
            <% total += product.price * quantity %>
          </li>
        <% end %>
      </ul>

      <!-- 合計金額 -->
      <p><strong>合計金額:</strong> ¥<%= number_with_delimiter(total) %></p>
    <% end %>

    <!-- ✅ 支払いボタン -->
    <%= button_to "支払い", orders_path, method: :post, class: "form-button blue" %>

    <!-- 🔁 カートを空にする -->
    <%= button_to "カゴを空にする", clear_cart_orders_path, method: :post, class: "form-button red" %>


  <% else %>
    <p>カートに商品はありません</p>
  <% end %>
</div>


<!-- 🔙 トップに戻る -->
<%= link_to "トップページに戻る", root_path, class: "form-button gray" %>


<script>
  document.addEventListener("DOMContentLoaded", () => {
    const productName = localStorage.getItem
